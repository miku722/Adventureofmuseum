# ç³»ç»Ÿæ¶æ„å¯è§†åŒ–å›¾

## ğŸ—ï¸ æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         æ¸¸æˆåº”ç”¨å±‚                                â”‚
â”‚                        (App.tsx)                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                             â”‚
                             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      GameCover ç»„ä»¶                              â”‚
â”‚                    (å…¨å±€çŠ¶æ€ç®¡ç†ä¸­å¿ƒ)                             â”‚
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚  GameState {                                            â”‚    â”‚
â”‚  â”‚    playerName: "ææ˜"                                   â”‚    â”‚
â”‚  â”‚    currentPhase: "scenes"                               â”‚    â”‚
â”‚  â”‚    currentScene: "åœºæ™¯2ï¼šå¤±æ§çš„ç›‘æ§å®¤"                  â”‚    â”‚
â”‚  â”‚    narrativeHistory: [                                  â”‚    â”‚
â”‚  â”‚      "ã€åºç« ã€‘...",                                      â”‚    â”‚
â”‚  â”‚      "ã€åœºæ™¯1ã€‘..."                                      â”‚    â”‚
â”‚  â”‚    ]                                                     â”‚    â”‚
â”‚  â”‚    conversationHistory: [                               â”‚    â”‚
â”‚  â”‚      "ã€åœºæ™¯1å¯¹è¯ã€‘å®ˆæœ›è€…ï¼šæ™šä¸Šå¥½...\nææ˜ï¼š..."         â”‚    â”‚
â”‚  â”‚    ]                                                     â”‚    â”‚
â”‚  â”‚    playerChoice: null                                   â”‚    â”‚
â”‚  â”‚  }                                                       â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                                                  â”‚
â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚              â”‚              â”‚              â”‚
    â–¼              â–¼              â–¼              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚NameInputâ”‚  â”‚StoryNarrationâ”‚ â”‚Scenes1-5 â”‚  â”‚Chapter1Marketâ”‚
â”‚  ç»„ä»¶   â”‚  â”‚   ç»„ä»¶       â”‚  â”‚  ç»„ä»¶    â”‚  â”‚    ç»„ä»¶      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚              â”‚
                   â”‚              â”‚
                   â–¼              â–¼
            è¿”å›å™äº‹ç‰‡æ®µ    è¿”å›å¯¹è¯å†å²
                   â”‚              â”‚
                   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
                          â”‚
                          â–¼
                  æ›´æ–°GameState
```

## ğŸ”„ æ•°æ®æµè¯¦è§£

### 1. å™äº‹ç»„ä»¶æ•°æ®æµ

```
StoryNarration.tsx
    â”‚
    â”‚ æ˜¾ç¤º3æ®µå™äº‹æ–‡æœ¬
    â”‚
    â”œâ”€â–º "è¿™æ˜¯ä½ æ‹…ä»»å®ˆå¤œäººçš„ç¬¬ä¸‰å¹´..."
    â”œâ”€â–º "ä½ èµ°åœ¨ä¸‡ç±ä¿±å¯‚çš„å±•å…ä¸­..."
    â””â”€â–º "ä½ ç»™è‡ªå·±å€’äº†ä¸€æ¯èŠèŠ±èŒ¶..."
    â”‚
    â”‚ ç©å®¶ç‚¹å‡»"ç»§ç»­"
    â”‚
    â–¼
onComplete(narratives: string[])
    â”‚
    â”‚ ä¼ é€’å™äº‹æ•°ç»„ç»™GameCover
    â”‚
    â–¼
GameCover.setGameState(prev => ({
  ...prev,
  narrativeHistory: [
    ...prev.narrativeHistory,
    "ã€åºç« ã€‘\nè¿™æ˜¯ä½ æ‹…ä»»å®ˆå¤œäººçš„ç¬¬ä¸‰å¹´...\n..."
  ]
}))
```

### 2. åœºæ™¯å¯¹è¯æ•°æ®æµ

```
CombinedScenes1to5.tsx
    â”‚
    â”‚ åœºæ™¯1å¼€å§‹
    â”‚
    â–¼
æ„å»ºSystemPrompt
    â”‚
    â”œâ”€â–º buildGlobalSystemPrompt(gameState)
    â”‚   â””â”€â–º åŒ…å«ï¼šåŸºç¡€è®¾å®š + åºç« å™äº‹
    â”‚
    â””â”€â–º addSceneContext(basePrompt, SCENE_CONTEXTS.scene1)
        â””â”€â–º æ·»åŠ ï¼šåœºæ™¯1ç‰¹å®šæŒ‡ä»¤
    â”‚
    â–¼
InteractiveScene.tsx
    â”‚
    â”‚ AIï¼šæ™šä¸Šå¥½ï¼Œææ˜ã€‚æ‰€æœ‰ç›‘æ§æ­£å¸¸...
    â”‚ ç©å®¶ï¼šæœ‰ä»€ä¹ˆéœ€è¦æ³¨æ„çš„å—ï¼Ÿ
    â”‚ AIï¼šä»Šæ™šä¸€åˆ‡å¹³é™ï¼Œæ‚¨å¯ä»¥...
    â”‚
    â”‚ å¯¹è¯å®Œæˆï¼ˆè¾¾åˆ°minMessagesï¼‰
    â”‚
    â–¼
onComplete(conversationHistory: string)
    â”‚
    â”‚ è¿”å›æ ¼å¼åŒ–çš„å¯¹è¯å†å²
    â”‚
    â–¼
handleSceneComplete(history)
    â”‚
    â”œâ”€â–º æ·»åŠ åœºæ™¯æè¿°åˆ°narrativeHistory
    â””â”€â–º æ·»åŠ å¯¹è¯åˆ°conversationHistory
    â”‚
    â–¼
onUpdateGameState((prev) => ({
  ...prev,
  narrativeHistory: [...prev.narrativeHistory, "ã€åœºæ™¯1ã€‘..."],
  conversationHistory: [...prev.conversationHistory, "ã€åœºæ™¯1å¯¹è¯ã€‘..."]
}))
    â”‚
    â”‚ è¿›å…¥åœºæ™¯2
    â”‚
    â–¼
åœºæ™¯2çš„SystemPromptç°åœ¨åŒ…å«ï¼š
    â”œâ”€ åŸºç¡€è®¾å®š
    â”œâ”€ åºç« å™äº‹
    â”œâ”€ åœºæ™¯1æè¿°
    â”œâ”€ åœºæ™¯1å¯¹è¯ âœ… AIèƒ½å¼•ç”¨ä¹‹å‰çš„å¯¹è¯ï¼
    â””â”€ åœºæ™¯2ç‰¹å®šæŒ‡ä»¤
```

## ğŸ§  SystemPromptæ„å»ºæµç¨‹

```
buildGlobalSystemPrompt(gameState)
    â”‚
    â”œâ”€â–º Step 1: æ·»åŠ åŸºç¡€è®¾å®š
    â”‚   â”‚
    â”‚   â””â”€â–º ä½ æ˜¯åšç‰©é¦†çš„æ™ºèƒ½ç›‘æ§ç³»ç»ŸAIåŠ©æ‰‹...
    â”‚       â”œâ”€ æ ¸å¿ƒèº«ä»½
    â”‚       â”œâ”€ æ€§æ ¼ç‰¹ç‚¹
    â”‚       â”œâ”€ é‡è¦è§„åˆ™
    â”‚       â””â”€ å½“å‰æ¸¸æˆä¿¡æ¯
    â”‚
    â”œâ”€â–º Step 2: æ·»åŠ å·²å‘ç”Ÿçš„æ•…äº‹
    â”‚   â”‚
    â”‚   â””â”€â–º narrativeHistory.forEach()
    â”‚       â”œâ”€ ã€ç‰‡æ®µ1ã€‘åºç« å™äº‹
    â”‚       â”œâ”€ ã€ç‰‡æ®µ2ã€‘åœºæ™¯1æè¿°
    â”‚       â””â”€ ã€ç‰‡æ®µ3ã€‘åœºæ™¯2æè¿°
    â”‚
    â”œâ”€â–º Step 3: æ·»åŠ å¯¹è¯å†å²
    â”‚   â”‚
    â”‚   â””â”€â–º conversationHistory.forEach()
    â”‚       â”œâ”€ ã€åœºæ™¯1å¯¹è¯ã€‘å®ˆæœ›è€…ï¼š...\nç©å®¶ï¼š...
    â”‚       â””â”€ ã€åœºæ™¯2å¯¹è¯ã€‘å®ˆæœ›è€…ï¼š...\nç©å®¶ï¼š...
    â”‚
    â””â”€â–º è¿”å›: basePrompt (åŒ…å«å®Œæ•´å†å²)
    â”‚
    â–¼
addSceneContext(basePrompt, sceneContext)
    â”‚
    â””â”€â–º basePrompt + "\n\n===å½“å‰åœºæ™¯æŒ‡ä»¤===\n" + sceneContext
    â”‚
    â–¼
æœ€ç»ˆçš„SystemPrompt (ä¼ é€’ç»™AI)
```

## ğŸ® åœºæ™¯ç®¡ç†æ¶æ„

```
CombinedScenes1to5
    â”‚
    â”œâ”€â–º State: currentScene = 1
    â”‚
    â”œâ”€â–º åœºæ™¯é…ç½®æ•°ç»„
    â”‚   â”‚
    â”‚   â”œâ”€ Scene 1: { title, sceneKey, description, ... }
    â”‚   â”œâ”€ Scene 2: { title, sceneKey, description, ... }
    â”‚   â”œâ”€ Scene 3: { title, sceneKey, description, ... }
    â”‚   â”œâ”€ Scene 4: { title, sceneKey, description, ... }
    â”‚   â””â”€ Scene 5: { title, sceneKey, description, ... }
    â”‚
    â”œâ”€â–º buildSystemPrompt()
    â”‚   â”‚
    â”‚   â”œâ”€ gameState + currentSceneä¿¡æ¯
    â”‚   â””â”€ SCENE_CONTEXTS[sceneKey]
    â”‚
    â”œâ”€â–º InteractiveScene (æ¸²æŸ“å½“å‰åœºæ™¯)
    â”‚   â”‚
    â”‚   â””â”€ key={currentScene} â† é‡è¦ï¼šåœºæ™¯åˆ‡æ¢æ—¶é‡æ–°æŒ‚è½½
    â”‚
    â””â”€â–º handleSceneComplete()
        â”‚
        â”œâ”€ ä¿å­˜åœºæ™¯æè¿°å’Œå¯¹è¯
        â”œâ”€ æ›´æ–°GameState
        â”‚
        â””â”€ currentScene < 5 ? 
            â”œâ”€ YES â†’ setCurrentScene(currentScene + 1)
            â””â”€ NO  â†’ onComplete() (æ‰€æœ‰åœºæ™¯ï¿½ï¿½æˆ)
```

## ğŸ” è°ƒè¯•å™¨æ¶æ„

```
GameStateDebugger
    â”‚
    â”œâ”€â–º æ¥æ”¶: gameState (å®æ—¶)
    â”‚
    â”œâ”€â–º æ˜¾ç¤ºç»„ä»¶
    â”‚   â”‚
    â”‚   â”œâ”€â–º åŸºæœ¬ä¿¡æ¯å¡ç‰‡
    â”‚   â”‚   â”œâ”€ ç©å®¶åå­—
    â”‚   â”‚   â”œâ”€ å½“å‰é˜¶æ®µ
    â”‚   â”‚   â”œâ”€ å½“å‰åœºæ™¯
    â”‚   â”‚   â””â”€ ç©å®¶é€‰æ‹©
    â”‚   â”‚
    â”‚   â”œâ”€â–º å™äº‹å†å² (å¯æŠ˜å )
    â”‚   â”‚   â”œâ”€ æ˜¾ç¤ºæ•°é‡
    â”‚   â”‚   â””â”€ åˆ—è¡¨å±•ç¤º
    â”‚   â”‚
    â”‚   â”œâ”€â–º å¯¹è¯å†å² (å¯æŠ˜å )
    â”‚   â”‚   â”œâ”€ æ˜¾ç¤ºæ•°é‡
    â”‚   â”‚   â””â”€ åˆ—è¡¨å±•ç¤º
    â”‚   â”‚
    â”‚   â””â”€â–º ç»Ÿè®¡ä¿¡æ¯
    â”‚       â”œâ”€ å™äº‹ç‰‡æ®µæ•°
    â”‚       â””â”€ å¯¹è¯åœºæ™¯æ•°
    â”‚
    â””â”€â–º ä½ç½®: fixed bottom-4 right-4
```

## ğŸ“¦ ç»„ä»¶ä¾èµ–å…³ç³»

```
App.tsx
  â””â”€â–º GameProvider (Context)
       â””â”€â–º GameCover
            â”œâ”€â–º GameStateDebugger â”€â”€â”
            â”‚                       â”‚
            â”œâ”€â–º DebugPanel          â”‚
            â”‚                       â”‚
            â”œâ”€â–º NameInput           â”‚
            â”‚                       â”‚  ä¾èµ–
            â”œâ”€â–º ChapterIntro        â”‚  gameState
            â”‚                       â”‚
            â”œâ”€â–º StoryNarration      â”‚
            â”‚   â””â”€â–º NarrativeSceneBase
            â”‚                       â”‚
            â”œâ”€â–º CombinedScenes1to5 â”€â”¤
            â”‚   â””â”€â–º InteractiveScene
            â”‚       â”œâ”€â–º GlitchText
            â”‚       â”œâ”€â–º Input (UI)
            â”‚       â””â”€â–º Button (UI)
            â”‚                       â”‚
            â”œâ”€â–º TransitionAndChoice â”‚
            â”‚                       â”‚
            â”œâ”€â–º Chapter1Intro       â”‚
            â”‚                       â”‚
            â”œâ”€â–º MarketIntroNarrationâ”‚
            â”‚   â””â”€â–º NarrativeSceneBase
            â”‚                       â”‚
            â””â”€â–º Chapter1Market â”€â”€â”€â”€â”€â”˜
                â”œâ”€â–º Inventory
                â””â”€â–º DialogueBox
```

## ğŸ› ï¸ å·¥å…·å‡½æ•°ä¾èµ–

```
/utils/gameSystemPrompt.ts
    â”‚
    â”œâ”€â–º export interface GameState
    â”‚
    â”œâ”€â–º export function buildGlobalSystemPrompt()
    â”‚   â”‚
    â”‚   â””â”€â–º ä½¿ç”¨: GameState
    â”‚
    â”œâ”€â–º export function addSceneContext()
    â”‚
    â””â”€â–º export const SCENE_CONTEXTS
        â”‚
        â”œâ”€â–º scene1
        â”œâ”€â–º scene2
        â”œâ”€â–º scene3
        â”œâ”€â–º scene4
        â”œâ”€â–º scene5
        â””â”€â–º market

è¢«ä»¥ä¸‹ç»„ä»¶å¯¼å…¥:
    â”œâ”€â–º GameCover.tsx
    â”œâ”€â–º CombinedScenes1to5.tsx
    â””â”€â–º GameStateDebugger.tsx
```

## ğŸ” ç±»å‹å®‰å…¨æµç¨‹

```
TypeScriptç±»å‹æ£€æŸ¥
    â”‚
    â”œâ”€â–º GameStateæ¥å£
    â”‚   â””â”€â–º ç¡®ä¿æ‰€æœ‰å­—æ®µç±»å‹æ­£ç¡®
    â”‚
    â”œâ”€â–º SCENE_CONTEXTSé”®å€¼
    â”‚   â””â”€â–º sceneKey: "scene1" as const
    â”‚
    â”œâ”€â–º Propsæ¥å£
    â”‚   â”œâ”€â–º CombinedScenes1to5Props
    â”‚   â”œâ”€â–º InteractiveSceneProps
    â”‚   â””â”€â–º GameStateDebuggerProps
    â”‚
    â””â”€â–º å‡½æ•°ç­¾å
        â”œâ”€â–º buildGlobalSystemPrompt(gameState: GameState): string
        â”œâ”€â–º addSceneContext(base: string, context: string): string
        â””â”€â–º onUpdateGameState: (updater: (prev: GameState) => GameState) => void
```

## ğŸ¯ çŠ¶æ€æ›´æ–°æ¨¡å¼

```
ä¸å¯å˜æ›´æ–°æ¨¡å¼

âŒ é”™è¯¯:
gameState.narrativeHistory.push(newNarrative);
setGameState(gameState);

âœ… æ­£ç¡®:
setGameState(prev => ({
  ...prev,
  narrativeHistory: [...prev.narrativeHistory, newNarrative]
}));

æˆ–ä½¿ç”¨å›è°ƒ:
onUpdateGameState(prev => ({
  ...prev,
  narrativeHistory: [...prev.narrativeHistory, newNarrative],
  conversationHistory: [...prev.conversationHistory, newConversation]
}));
```

## ğŸ“Š æ€§èƒ½ä¼˜åŒ–ç‚¹

```
ä¼˜åŒ–ç­–ç•¥
    â”‚
    â”œâ”€â–º React.memo() 
    â”‚   â””â”€â–º ç”¨äºä¸ç»å¸¸æ›´æ–°çš„ç»„ä»¶
    â”‚
    â”œâ”€â–º useCallback()
    â”‚   â””â”€â–º ç¨³å®šçš„å›è°ƒå‡½æ•°å¼•ç”¨
    â”‚
    â”œâ”€â–º keyå±æ€§
    â”‚   â””â”€â–º InteractiveSceneä½¿ç”¨key={currentScene}å¼ºåˆ¶é‡æ–°æŒ‚è½½
    â”‚
    â”œâ”€â–º æ¡ä»¶æ¸²æŸ“
    â”‚   â””â”€â–º åªæ¸²æŸ“å½“å‰éœ€è¦çš„ç»„ä»¶
    â”‚
    â””â”€â–º æ‡’åŠ è½½ï¼ˆæœªæ¥ï¼‰
        â””â”€â–º å†å²è®°å½•å‹ç¼©å’Œæ‘˜è¦
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0  
**æœ€åæ›´æ–°**: 2025-11-07
